<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dynamic Library</title>
</head>
<body>
  <div data-role="page" id="dynamicLibraryConfigPage" class="page type-interior pluginConfigurationPage">
    <div data-role="content">
      <div class="content-primary">
        <form id="dynamicLibraryForm">
          <div class="verticalSection">
            <div class="sectionTitleContainer flex align-items-center">
              <h2 class="sectionTitle">Dynamic Library</h2>
            </div>
            <p class="fieldDescription">
              Create an infinite library by searching TVDB and TMDB for content not in your library.
              When you click on a result, Embedarr will generate STRM files automatically.
            </p>
          </div>

          <div class="verticalSection">
            <div class="checkboxContainer checkboxContainer-withDescription">
              <label>
                <input is="emby-checkbox" type="checkbox" id="chkEnabled" />
                <span>Enable Dynamic Library</span>
              </label>
              <div class="fieldDescription">Enable or disable the plugin globally.</div>
            </div>
          </div>

          <div class="verticalSection">
            <h3 class="sectionTitle">API Keys</h3>

            <div class="inputContainer">
              <label class="inputLabel inputLabelUnfocused" for="txtTvdbApiKey">TVDB API Key:</label>
              <input is="emby-input" type="password" id="txtTvdbApiKey" class="emby-input" />
              <div class="fieldDescription">
                API key for TVDB (used for TV shows and anime).
                Get one at <a href="https://thetvdb.com/api-information" target="_blank">thetvdb.com</a>.
              </div>
            </div>

            <div class="inputContainer">
              <label class="inputLabel inputLabelUnfocused" for="txtTmdbApiKey">TMDB API Key:</label>
              <input is="emby-input" type="password" id="txtTmdbApiKey" class="emby-input" />
              <div class="fieldDescription">
                API key for TMDB (used for movies).
                Get one at <a href="https://www.themoviedb.org/settings/api" target="_blank">themoviedb.org</a>.
              </div>
            </div>
          </div>

          <div class="verticalSection">
            <h3 class="sectionTitle">Stream Provider</h3>

            <div class="inputContainer">
              <label class="inputLabel inputLabelUnfocused" for="selStreamProvider">Provider:</label>
              <select is="emby-select" id="selStreamProvider" class="emby-select">
                <option value="None">None (Browse Only)</option>
                <option value="Embedarr">Embedarr</option>
                <option value="Direct">Direct URL Templates</option>
              </select>
              <div class="fieldDescription">
                None: Browse content without streaming capability.<br>
                Embedarr: Use Embedarr to generate STRM files and stream.<br>
                Direct: Use custom URL templates for direct streaming.
              </div>
            </div>
          </div>

          <div class="verticalSection" id="embedarrSettings" style="display: none;">
            <h3 class="sectionTitle">Embedarr Settings</h3>

            <div class="inputContainer">
              <label class="inputLabel inputLabelUnfocused" for="txtEmbedarrUrl">Embedarr URL:</label>
              <input is="emby-input" type="text" id="txtEmbedarrUrl" class="emby-input" placeholder="http://localhost:8080" />
              <div class="fieldDescription">URL to your Embedarr instance for STRM file generation.</div>
            </div>

            <div class="inputContainer">
              <label class="inputLabel inputLabelUnfocused" for="txtEmbedarrApiKey">Embedarr API Key:</label>
              <input is="emby-input" type="password" id="txtEmbedarrApiKey" class="emby-input" />
              <div class="fieldDescription">API key for Embedarr (if required).</div>
            </div>

            <div class="checkboxContainer checkboxContainer-withDescription">
              <label>
                <input is="emby-checkbox" type="checkbox" id="chkCreateMediaOnView" />
                <span>Pre-create media when viewing details</span>
              </label>
              <div class="fieldDescription">
                When enabled, Embedarr will add media to the library when you view item details.
                When disabled (default), media is only streamed on-demand when you click play.
              </div>
            </div>
          </div>

          <div class="verticalSection" id="directSettings" style="display: none;">
            <h3 class="sectionTitle">Direct URL Templates</h3>
            <p class="fieldDescription" style="margin-bottom: 1em;">
              Configure URL templates for direct streaming. Available placeholders:<br>
              <code>{id}</code> - Preferred ID (based on Provider ID Preferences below)<br>
              <code>{imdb}</code> - IMDB ID (e.g., tt1234567)<br>
              <code>{tmdb}</code> - TMDB ID (numeric, movies only)<br>
              <code>{tvdb}</code> - TVDB ID (numeric, TV/anime only)<br>
              <code>{season}</code> - Season number<br>
              <code>{episode}</code> - Episode number<br>
              <code>{title}</code> - URL-encoded title
            </p>

            <div class="inputContainer">
              <label class="inputLabel inputLabelUnfocused" for="txtDirectMovieUrl">Movie URL Template:</label>
              <input is="emby-input" type="text" id="txtDirectMovieUrl" class="emby-input" placeholder="https://example.com/movie/{imdb}.m3u8" />
              <div class="fieldDescription">Template for movie streams. Placeholders: {id}, {imdb}, {tmdb}, {title}</div>
            </div>

            <div class="inputContainer">
              <label class="inputLabel inputLabelUnfocused" for="txtDirectTvUrl">TV Show URL Template:</label>
              <input is="emby-input" type="text" id="txtDirectTvUrl" class="emby-input" placeholder="https://example.com/tv/{imdb}/{season}/{episode}.m3u8" />
              <div class="fieldDescription">Template for TV episodes. Placeholders: {id}, {imdb}, {tvdb}, {season}, {episode}, {title}</div>
            </div>

            <div class="inputContainer">
              <label class="inputLabel inputLabelUnfocused" for="txtDirectAnimeUrl">Anime URL Template:</label>
              <input is="emby-input" type="text" id="txtDirectAnimeUrl" class="emby-input" placeholder="https://example.com/anime/{tvdb}/{season}/{episode}.m3u8" />
              <div class="fieldDescription">Template for anime episodes. Placeholders: {id}, {imdb}, {tvdb}, {season}, {episode}, {title}</div>
            </div>
          </div>

          <div class="verticalSection">
            <h3 class="sectionTitle">Search Options</h3>

            <div class="checkboxContainer">
              <label>
                <input is="emby-checkbox" type="checkbox" id="chkSearchMovies" />
                <span>Search Movies (TMDB)</span>
              </label>
            </div>

            <div class="checkboxContainer">
              <label>
                <input is="emby-checkbox" type="checkbox" id="chkSearchTvShows" />
                <span>Search TV Shows (TVDB)</span>
              </label>
            </div>

            <div class="checkboxContainer">
              <label>
                <input is="emby-checkbox" type="checkbox" id="chkSearchAnime" />
                <span>Search Anime (TVDB)</span>
              </label>
            </div>

            <div class="inputContainer">
              <label class="inputLabel inputLabelUnfocused" for="txtMaxSearchResults">Max Search Results:</label>
              <input is="emby-input" type="number" id="txtMaxSearchResults" class="emby-input" min="1" max="100" />
              <div class="fieldDescription">Maximum number of results to return per API (1-100).</div>
            </div>
          </div>

          <div class="verticalSection">
            <h3 class="sectionTitle">Language Settings</h3>

            <div class="inputContainer">
              <label class="inputLabel inputLabelUnfocused" for="selLanguageMode">Language Mode:</label>
              <select is="emby-select" id="selLanguageMode" class="emby-select">
                <option value="Default">Default (Original Language)</option>
                <option value="Override">Override (Force Specific Language)</option>
              </select>
              <div class="fieldDescription">
                Default: Use original titles/descriptions from TVDB/TMDB.<br>
                Override: Request content in your preferred language (translations may not be available for all content).
              </div>
            </div>

            <div class="inputContainer" id="languageOverrideContainer" style="display: none;">
              <label class="inputLabel inputLabelUnfocused" for="selPreferredLanguage">Preferred Language:</label>
              <select is="emby-select" id="selPreferredLanguage" class="emby-select">
                <option value="eng">English</option>
                <option value="jpn">Japanese</option>
                <option value="spa">Spanish</option>
                <option value="fra">French</option>
                <option value="deu">German</option>
                <option value="ita">Italian</option>
                <option value="por">Portuguese</option>
                <option value="rus">Russian</option>
                <option value="zho">Chinese</option>
                <option value="kor">Korean</option>
                <option value="ara">Arabic</option>
                <option value="hin">Hindi</option>
                <option value="tha">Thai</option>
                <option value="vie">Vietnamese</option>
                <option value="nld">Dutch</option>
                <option value="pol">Polish</option>
                <option value="tur">Turkish</option>
                <option value="swe">Swedish</option>
                <option value="nor">Norwegian</option>
                <option value="dan">Danish</option>
                <option value="fin">Finnish</option>
                <option value="ukr">Ukrainian</option>
              </select>
              <div class="fieldDescription">
                Language for titles and metadata. Note: TMDB has better translation support than TVDB.
                Anime titles from TVDB may still appear in Japanese if no English translation exists.
              </div>
            </div>
          </div>

          <div class="verticalSection">
            <h3 class="sectionTitle">Provider ID Preferences</h3>
            <p class="fieldDescription" style="margin-bottom: 1em;">
              Select which provider ID to use when sending requests to Embedarr for streaming.
              IMDB is recommended as it has the widest support. If the preferred ID is not available,
              the plugin will fall back to other available IDs.
            </p>

            <div class="inputContainer">
              <label class="inputLabel inputLabelUnfocused" for="selMoviePreferredId">Movies:</label>
              <select is="emby-select" id="selMoviePreferredId" class="emby-select">
                <option value="Imdb">IMDB (Recommended)</option>
                <option value="Tmdb">TMDB</option>
              </select>
              <div class="fieldDescription">
                Movies are sourced from TMDB. IMDB ID is fetched from movie details. TMDB ID is always available.
              </div>
            </div>

            <div class="inputContainer">
              <label class="inputLabel inputLabelUnfocused" for="selTvShowPreferredId">TV Shows:</label>
              <select is="emby-select" id="selTvShowPreferredId" class="emby-select">
                <option value="Imdb">IMDB (Recommended)</option>
                <option value="Tvdb">TVDB</option>
              </select>
              <div class="fieldDescription">
                TV shows are sourced from TVDB. IMDB ID is fetched from remote IDs. TVDB ID is always available.
              </div>
            </div>

            <div class="inputContainer">
              <label class="inputLabel inputLabelUnfocused" for="selAnimePreferredId">Anime:</label>
              <select is="emby-select" id="selAnimePreferredId" class="emby-select">
                <option value="Imdb">IMDB (Recommended)</option>
                <option value="Tvdb">TVDB</option>
              </select>
              <div class="fieldDescription">
                Anime is sourced from TVDB. IMDB ID is fetched from remote IDs when available.
                Note: Some anime may not have IMDB IDs; TVDB will be used as fallback.
              </div>
            </div>
          </div>

          <div class="verticalSection">
            <h3 class="sectionTitle">Cache Settings</h3>

            <div class="inputContainer">
              <label class="inputLabel inputLabelUnfocused" for="txtCacheTtlMinutes">Cache TTL (minutes):</label>
              <input is="emby-input" type="number" id="txtCacheTtlMinutes" class="emby-input" min="1" max="1440" />
              <div class="fieldDescription">How long to cache search results (1-1440 minutes).</div>
            </div>
          </div>

          <div>
            <button id="btnSave" is="emby-button" type="submit" class="raised button-submit block emby-button">
              <span>Save</span>
            </button>
          </div>
        </form>
      </div>
    </div>

    <script type="text/javascript">
      (function () {
        'use strict';

        const pluginId = 'A1B2C3D4-E5F6-7890-ABCD-EF1234567890';
        const page = document.querySelector('#dynamicLibraryConfigPage');
        const form = document.querySelector('#dynamicLibraryForm');

        // Cache DOM elements - inputs
        const chkEnabled = document.querySelector('#chkEnabled');
        const txtTvdbApiKey = document.querySelector('#txtTvdbApiKey');
        const txtTmdbApiKey = document.querySelector('#txtTmdbApiKey');
        const txtEmbedarrUrl = document.querySelector('#txtEmbedarrUrl');
        const txtEmbedarrApiKey = document.querySelector('#txtEmbedarrApiKey');
        const chkCreateMediaOnView = document.querySelector('#chkCreateMediaOnView');
        const chkSearchMovies = document.querySelector('#chkSearchMovies');
        const chkSearchTvShows = document.querySelector('#chkSearchTvShows');
        const chkSearchAnime = document.querySelector('#chkSearchAnime');
        const txtMaxSearchResults = document.querySelector('#txtMaxSearchResults');
        const txtCacheTtlMinutes = document.querySelector('#txtCacheTtlMinutes');

        // Cache DOM elements - Direct URL templates
        const txtDirectMovieUrl = document.querySelector('#txtDirectMovieUrl');
        const txtDirectTvUrl = document.querySelector('#txtDirectTvUrl');
        const txtDirectAnimeUrl = document.querySelector('#txtDirectAnimeUrl');

        // Cache DOM elements - selects
        const selStreamProvider = document.querySelector('#selStreamProvider');
        const selLanguageMode = document.querySelector('#selLanguageMode');
        const selPreferredLanguage = document.querySelector('#selPreferredLanguage');
        const selMoviePreferredId = document.querySelector('#selMoviePreferredId');
        const selTvShowPreferredId = document.querySelector('#selTvShowPreferredId');
        const selAnimePreferredId = document.querySelector('#selAnimePreferredId');

        // Cache DOM elements - conditional containers
        const embedarrSettings = document.querySelector('#embedarrSettings');
        const directSettings = document.querySelector('#directSettings');
        const languageOverrideContainer = document.querySelector('#languageOverrideContainer');

        function updateLanguageVisibility() {
          const mode = selLanguageMode.value;
          languageOverrideContainer.style.display = mode === 'Override' ? 'block' : 'none';
        }

        function updateStreamProviderVisibility() {
          const provider = selStreamProvider.value;
          embedarrSettings.style.display = provider === 'Embedarr' ? 'block' : 'none';
          directSettings.style.display = provider === 'Direct' ? 'block' : 'none';
        }

        // Helper to set select value - handles custom element timing
        function setSelectValue(selectEl, value) {
          // Try setting immediately
          selectEl.value = value;

          // Also schedule a delayed set in case custom element isn't ready
          setTimeout(function() {
            if (selectEl.value !== value) {
              selectEl.value = value;
              console.log('Dynamic Library: Delayed set for', selectEl.id, 'to', value);
            }
          }, 100);
        }

        let isLoading = false;
        async function loadConfig() {
          if (isLoading) return;
          isLoading = true;

          Dashboard.showLoadingMsg();
          try {
            const config = await window.ApiClient.getPluginConfiguration(pluginId);
            console.log('Dynamic Library: Loaded config', config);

            // Checkboxes
            chkEnabled.checked = config.Enabled ?? true;
            chkCreateMediaOnView.checked = config.CreateMediaOnView ?? false;
            chkSearchMovies.checked = config.SearchMovies ?? true;
            chkSearchTvShows.checked = config.SearchTvShows ?? true;
            chkSearchAnime.checked = config.SearchAnime ?? true;

            // Text inputs
            txtTvdbApiKey.value = config.TvdbApiKey || '';
            txtTmdbApiKey.value = config.TmdbApiKey || '';
            txtEmbedarrUrl.value = config.EmbedarrUrl || '';
            txtEmbedarrApiKey.value = config.EmbedarrApiKey || '';

            // Number inputs
            txtMaxSearchResults.value = config.MaxSearchResults ?? 20;
            txtCacheTtlMinutes.value = config.CacheTtlMinutes ?? 60;

            // Direct URL templates
            txtDirectMovieUrl.value = config.DirectMovieUrlTemplate || '';
            txtDirectTvUrl.value = config.DirectTvUrlTemplate || '';
            txtDirectAnimeUrl.value = config.DirectAnimeUrlTemplate || '';

            // Select dropdowns - use helper to handle custom element timing
            // Enum values come as strings from C# JSON serialization
            setSelectValue(selStreamProvider, config.StreamProvider || 'None');
            setSelectValue(selLanguageMode, config.LanguageMode || 'Default');
            setSelectValue(selPreferredLanguage, config.PreferredLanguage || 'eng');
            setSelectValue(selMoviePreferredId, config.MoviePreferredId || 'Imdb');
            setSelectValue(selTvShowPreferredId, config.TvShowPreferredId || 'Imdb');
            setSelectValue(selAnimePreferredId, config.AnimePreferredId || 'Imdb');

            updateStreamProviderVisibility();
            updateLanguageVisibility();
          } catch (err) {
            console.error('Dynamic Library: Failed to load configuration', err);
          } finally {
            Dashboard.hideLoadingMsg();
            isLoading = false;
          }
        }

        async function saveConfig(e) {
          e.preventDefault();
          Dashboard.showLoadingMsg();
          try {
            const config = await window.ApiClient.getPluginConfiguration(pluginId);

            // Checkboxes
            config.Enabled = chkEnabled.checked;
            config.CreateMediaOnView = chkCreateMediaOnView.checked;
            config.SearchMovies = chkSearchMovies.checked;
            config.SearchTvShows = chkSearchTvShows.checked;
            config.SearchAnime = chkSearchAnime.checked;

            // Text inputs
            config.TvdbApiKey = txtTvdbApiKey.value.trim();
            config.TmdbApiKey = txtTmdbApiKey.value.trim();
            config.EmbedarrUrl = txtEmbedarrUrl.value.trim();
            config.EmbedarrApiKey = txtEmbedarrApiKey.value.trim();

            // Number inputs
            config.MaxSearchResults = parseInt(txtMaxSearchResults.value, 10) || 20;
            config.CacheTtlMinutes = parseInt(txtCacheTtlMinutes.value, 10) || 60;

            // Direct URL templates
            config.DirectMovieUrlTemplate = txtDirectMovieUrl.value.trim();
            config.DirectTvUrlTemplate = txtDirectTvUrl.value.trim();
            config.DirectAnimeUrlTemplate = txtDirectAnimeUrl.value.trim();

            // Select dropdowns - enum values are serialized as strings
            config.StreamProvider = selStreamProvider.value;
            config.LanguageMode = selLanguageMode.value;
            config.PreferredLanguage = selPreferredLanguage.value;
            config.MoviePreferredId = selMoviePreferredId.value;
            config.TvShowPreferredId = selTvShowPreferredId.value;
            config.AnimePreferredId = selAnimePreferredId.value;

            await window.ApiClient.updatePluginConfiguration(pluginId, config);
            Dashboard.processPluginConfigurationUpdateResult();
          } catch (err) {
            console.error('Dynamic Library: Failed to save configuration', err);
            Dashboard.alert('Failed to save configuration. Check console for details.');
          } finally {
            Dashboard.hideLoadingMsg();
          }
        }

        // Set up event listeners once
        form.addEventListener('submit', saveConfig);
        selStreamProvider.addEventListener('change', updateStreamProviderVisibility);
        selLanguageMode.addEventListener('change', updateLanguageVisibility);

        // Load config when page is shown (works with Jellyfin's SPA navigation)
        page.addEventListener('viewshow', loadConfig);
        page.addEventListener('pageshow', loadConfig);
      })();
    </script>
  </div>
</body>
</html>
